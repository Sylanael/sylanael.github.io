
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mayhemarchy: The Order of Nonsense</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Modern Sleek Theme */
body {
    font-family: 'Comic Neue', cursive;
    background: linear-gradient(135deg, #333 0%, #111 100%);
    color: #fff;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.container {
    max-width: 650px;
    width: calc(100% - 20px);
    background: #1e1e1e;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    border: 2px solid #333;
    position: relative;
    margin: 10px;
    overflow: hidden;
}

h1 {
    font-family: 'Bangers', cursive;
    color: #4CAF50;
    font-size: 3em;
    text-shadow: 2px 2px 0 #000;
    margin-top: 5px;
    letter-spacing: 2px;
    text-align: center;
}

.controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
    background: #2d2d2d;
    padding: 15px;
    border-radius: 10px;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    gap: 10px;
}

.checkbox-group {
    display: flex;
    justify-content: center;
    margin: 15px 0;
    gap: 15px;
    flex-wrap: wrap;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    font-size: 1.1em;
    cursor: pointer;
    padding: 8px 18px;
    background: #2d2d2d;
    border-radius: 30px;
    border: 1px solid #444;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: all 0.2s;
    color: #fff;
}

.checkbox-group label:hover {
    background: #3d3d3d;
    transform: translateY(-2px);
}

.checkbox-group label:active {
    transform: translateY(1px);
    box-shadow: 0 0 0 #333;
}

.checkbox-group input[type="checkbox"] {
    margin-right: 8px;
    width: 16px;
    height: 16px;
    accent-color: #4CAF50;
}

.draw-control {
    display: flex;
    align-items: center;
    background: #333;
    border-radius: 30px;
    padding: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.draw-btn {
    width: 36px;
    height: 36px;
    font-size: 1.2em;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 3px rgba(0,0,0,0.2);
    transition: all 0.2s;
}

.draw-btn:hover {
    background: #66BB6A;
    transform: translateY(-2px);
}

.draw-btn:active {
    transform: translateY(1px);
    box-shadow: 0 0 0 #2E7D32;
}

input {
    width: 50px;
    text-align: center;
    font-size: 1.3em;
    border: none;
    background: transparent;
    color: white;
    padding: 5px;
}

/* Create a container for the buttons */
.button-container {
    display: flex;
    justify-content: center;
    gap: 15px; /* Space between buttons */
    margin: 20px 0;
}

.draw-button {
    background: linear-gradient(to right, #4CAF50, #2E7D32);
    color: white;
    cursor: pointer;
    font-size: 1.5em;
    padding: 12px 30px;
    border: none;
    border-radius: 40px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: all 0.3s;
    font-family: 'Bangers', cursive;
    letter-spacing: 1px;
    margin: 0;
    flex: 1; /* Make buttons take equal space */
    max-width: 250px; /* Limit the maximum width */
    display: block;
    position: relative;
    overflow: hidden;
}

@media (max-width: 480px) {
    .button-container {
        flex-direction: column;
        align-items: center;
    }
    
    .draw-button {
        width: 100%;
        margin-bottom: 10px;
    }
}

.draw-button:hover {
    background: linear-gradient(to right, #66BB6A, #43A047);
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}

.draw-button:active {
    transform: translateY(1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.cards-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 30px;
    min-height: 150px;
    perspective: 1000px;
}

.card {
    width: 90px;
    height: 130px;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 1.8em;
    margin: 8px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transform: scale(0) rotate(-10deg);
    animation: drawAnimation 0.5s forwards;
    cursor: pointer;
    position: relative;
    transition: all 0.3s;
    background: white;
    overflow: hidden;
}

.card:hover {
    transform: scale(1.05) translateY(-10px) !important;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
}

.card-value {
    font-size: 1.1em;
    font-weight: bold;
    line-height: 1;
}

.card-suit {
    font-size: 2.2em;
    margin-top: 5px;
}

/* Enhanced joker styles to make it more clickable */
.card.joker {
    background: linear-gradient(135deg, #ff5722, #ffeb3b);
    color: white;
    font-weight: bold;
    border: 3px dashed #ff5722;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.9);
    animation: pulse 1.5s infinite alternate ease-in-out;
    z-index: 10; /* Higher z-index to ensure it's on top */
    transform: scale(1.05); /* Slightly larger */
    pointer-events: auto !important; /* Force pointer events */
    cursor: pointer !important;
    position: relative;
}

/* Make the "TAP TO REPLACE" more visible */
.joker:after {
    content: "TAP TO REPLACE";
    position: absolute;
    bottom: 5px;
    left: 0;
    right: 0;
    text-align: center;
    font-family: 'Bangers', cursive;
    font-size: 0.6em;
    color: white;
    text-shadow: 1px 1px 0 #333;
    z-index: 20;
    pointer-events: none; /* Let clicks pass through to the card */
}

/* Prevent card hover animation from making it harder to click */
.card.joker:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 0 25px rgba(255, 215, 0, 1);
}

@keyframes pulse {
    0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.7); }
    100% { box-shadow: 0 0 25px rgba(255, 215, 0, 1); }
}

@keyframes jokerAnimation {
    0% { transform: scale(0) rotate(10deg); opacity: 0; }
    60% { transform: scale(1.1) rotate(-5deg); opacity: 1; }
    100% { transform: scale(1.05) rotate(0deg); opacity: 1; pointer-events: auto; }
}

.result {
    font-size: 1.8em;
    margin-top: 30px;
    padding: 15px;
    background: linear-gradient(to right, #2d2d2d, #1a1a1a);
    color: white;
    border-radius: 12px;
    font-family: 'Bangers', cursive;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    text-align: center;
}

.successes-breakdown {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    gap: 15px;
}

.breakdown-item {
    background: rgba(255,255,255,0.1);
    padding: 5px 15px;
    border-radius: 20px;
    font-family: 'Comic Neue', cursive;
    font-size: 0.6em;
}

.breakdown-item.values { color: #ffcc00; }
.breakdown-item.suits { color: #4CAF50; }

.card.selected {
    border: 2px solid #4CAF50;
    box-shadow: 0 0 15px #4CAF50;
}

.selection-panel {
    display: none;
    margin: 15px auto;
    padding: 15px;
    background: #2d2d2d;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    max-width: 90%;
    text-align: center;
}

.selection-panel.active {
    display: block;
    animation: fadeIn 0.3s forwards;
}

.selection-panel p {
    margin: 0 0 10px 0;
    font-size: 1.2em;
}

.selection-panel button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 30px;
    font-family: 'Comic Neue', cursive;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    transition: all 0.2s;
}

.selection-panel button:hover {
    background: #66BB6A;
    transform: translateY(-2px);
}

.selection-panel button:active {
    transform: translateY(1px);
    box-shadow: none;
}

.magic-results {
    margin-top: 20px;
    animation: fadeIn 0.5s forwards;
}

.magic-results h3 {
    margin: 0 0 10px 0;
    font-family: 'Comic Neue', cursive;
    font-size: 0.7em;
    opacity: 0.8;
}

.magic-effect-box {
    background: linear-gradient(135deg, #4a148c 0%, #311b92 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    font-size: 0.7em;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    font-family: 'Comic Neue', cursive;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes drawAnimation {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    60% { transform: scale(1.1) rotate(5deg); opacity: 1; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

@media (max-width: 480px) {
    .checkbox-group {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .checkbox-group label {
        width: 80%;
    }
    
    .card {
        width: 70px;
        height: 100px;
        font-size: 1.4em;
        margin: 5px;
    }
    
    .result {
        font-size: 1.5em;
    }
    
    .successes-breakdown {
        flex-direction: column;
        align-items: center;
    }
    
    .breakdown-item {
        width: 80%;
    }
}

/* SweetAlert2 customization for dark theme */
.swal2-popup {
    background: #2d2d2d !important;
    color: #fff !important;
    border: 2px solid #444 !important;
    border-radius: 15px !important;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
}

.swal2-title {
    color: #4CAF50 !important;
    font-family: 'Bangers', cursive !important;
    font-size: 2.2em !important;
    margin-bottom: 20px !important;
    text-shadow: 2px 2px 0 #000 !important;
}

.swal2-html-container {
    color: #fff !important;
}

.swal2-html-container label {
    color: #4CAF50 !important;
    font-weight: bold !important;
    margin-right: 10px !important;
}

.swal2-html-container select {
    background: #444 !important;
    color: #fff !important;
    border: 2px solid #555 !important;
    border-radius: 10px !important;
    padding: 8px 12px !important;
    font-family: 'Comic Neue', cursive !important;
    margin: 8px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
}

.swal2-html-container select:focus {
    border-color: #4CAF50 !important;
    outline: none !important;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.5) !important;
}

.swal2-confirm {
    background: linear-gradient(to right, #4CAF50, #2E7D32) !important;
    border-radius: 30px !important;
    font-family: 'Comic Neue', cursive !important;
    font-weight: bold !important;
    padding: 12px 25px !important;
    font-size: 1.2em !important;
    box-shadow: 0 4px 0 #1B5E20 !important;
    transition: all 0.2s !important;
    border: none !important;
}

.swal2-confirm:hover {
    background: linear-gradient(to right, #66BB6A, #43A047) !important;
    transform: translateY(-2px) !important;
}

.swal2-confirm:active {
    transform: translateY(4px) !important;
    box-shadow: 0 0 0 #1B5E20 !important;
}

/* Make option text more readable */
.swal2-html-container option {
    background: #444 !important;
    color: #fff !important;
}

/* Add a subtle border around the content */
.swal2-html-container > div {
    background: rgba(0, 0, 0, 0.2) !important;
    padding: 15px !important;
    border-radius: 10px !important;
    border: 1px solid #444 !important;
}

/* Make the popup more mobile-friendly */
@media (max-width: 480px) {
    .swal2-popup {
        padding: 15px !important;
    </style>
</head>
<body>
    <div class="container">
        <h1>SLAP Draws Calculator</h1>
        <div class="controls">
            <label for="draws">Number of Draws:</label>
            <div class="draw-control">
                <button class="draw-btn" onclick="decrementDraws()">-</button>
                <input type="number" id="draws" min="4" max="8" value="4" readonly>
                <button class="draw-btn" onclick="incrementDraws()">+</button>
            </div>
        </div>
        <div class="checkbox-group">
            <label><input type="checkbox" id="advantage" onclick="toggleAdvDisadv('advantage')"> Advantage</label>
            <label><input type="checkbox" id="disadvantage" onclick="toggleAdvDisadv('disadvantage')"> Disadvantage</label>
            <label><input type="checkbox" id="magic" onclick="toggleMagic()"> Magic</label>

        </div>
        <div class="button-container">
            <button class="draw-button" onclick="calculateSuccess()">DRAW CARDS!</button>
            <button class="draw-button" style="background: linear-gradient(to right, #f44336, #d32f2f);" onclick="resetGame()">RESET</button>
        </div>
        <div id="selectionPanel" class="selection-panel">
            <p>Select <span id="selectionCount">0</span>/2 cards to drop</p>
            <button onclick="confirmCardSelection()">Confirm Selection</button>
        </div>
        <div class="cards-container" id="cardsContainer"></div>
        <div class="result" id="result">Ready to draw? Let's go!</div>
    </div>

<script type="text/javascript">
    // Global variables to track card selection
let selectedCards = [];
let cardsToSelect = 0;
let isSelectingCards = false;
let originalCards = [];
let finalCards = [];
let selectionComplete = false;

function resetGame() {
    // Reset number of draws to default (4)
    document.getElementById("draws").value = 4;

    // Uncheck all checkboxes (Advantage, Disadvantage, Magic)
    document.getElementById("advantage").checked = false;
    document.getElementById("disadvantage").checked = false;
    document.getElementById("magic").checked = false;

    // Clear the drawn cards display
    document.getElementById("cardsContainer").innerHTML = "";

    // Reset the result text
    document.getElementById("result").innerHTML = "Ready to draw? Let's go!";

    // Remove any magic effect display
    const magicEffectDiv = document.getElementById("magicEffect");
    if (magicEffectDiv) {
        magicEffectDiv.remove();
    }

    // Hide the card selection panel if active
    document.getElementById("selectionPanel").classList.remove('active');

    // Reset global tracking variables
    selectedCards = [];
    isSelectingCards = false;
    originalCards = [];
    finalCards = [];
    selectionComplete = false;
}


function incrementDraws() {
    let draws = parseInt(document.getElementById("draws").value);
    if (draws < 8) {
        document.getElementById("draws").value = draws + 1;
    }
}

function decrementDraws() {
    let draws = parseInt(document.getElementById("draws").value);
    if (draws > 4) {
        document.getElementById("draws").value = draws - 1;
    }
}

function toggleAdvDisadv(type) {
    if (type === 'advantage') {
        document.getElementById("disadvantage").checked = false;
    } else {
        document.getElementById("advantage").checked = false;
    }
}

function toggleMagic() {
    // Magic option can be used alongside advantage/disadvantage
    const isMagicChecked = document.getElementById("magic").checked;
    const currentDraws = parseInt(document.getElementById("draws").value);
    
    if (isMagicChecked && currentDraws < 4) {
        document.getElementById("draws").value = 4;
    }
}

function handleCardSelection(cardDiv, index) {
    if (!isSelectingCards) return;
    
    // Toggle selection
    if (selectedCards.includes(index)) {
        selectedCards = selectedCards.filter(i => i !== index);
        cardDiv.classList.remove('selected');
    } else if (selectedCards.length < cardsToSelect) {
        selectedCards.push(index);
        cardDiv.classList.add('selected');
    }
    
    document.getElementById('selectionCount').textContent = selectedCards.length;
}

function confirmCardSelection() {
    if (selectedCards.length !== cardsToSelect) {
        alert(`Please select exactly ${cardsToSelect} cards`);
        return;
    }
    
    isSelectingCards = false;
    selectionComplete = true;
    document.getElementById('selectionPanel').classList.remove('active');
    
    // Sort in descending order to avoid index shifting
    selectedCards.sort((a, b) => b - a);
    
    // Remove the selected cards
    selectedCards.forEach(index => {
        originalCards[index].element.remove();
        originalCards.splice(index, 1);
    });
    
    selectedCards = [];
    finalCards = originalCards.map(card => card.data);
    calculateSuccesses(finalCards);
}

function drawCards(numDraws) {
    let deck = [];
    
    // Create regular cards
    for (let i = 2; i <= 14; i++) {
        let value = i;
        if (i === 11) value = 'J';
        if (i === 12) value = 'Q';
        if (i === 13) value = 'K';
        if (i === 14) value = 'A';
        
        ['‚ô†Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è'].forEach(suit => {
            deck.push({ value: value, suit: suit, numValue: i });
        });
    }
    
    // Add jokers to the deck
    for (let i = 0; i < 2; i++) {
        deck.push({ value: 'Joker', suit: 'üÉè', numValue: 0 });
    }
    
    let drawnCards = [];
    for (let i = 0; i < numDraws; i++) {
        let cardIndex = Math.floor(Math.random() * deck.length);
        drawnCards.push(deck.splice(cardIndex, 1)[0]);
    }
    return drawnCards;
}

function calculateSuccess() {
    // Reset globals
    selectedCards = [];
    isSelectingCards = false;
    originalCards = [];
    finalCards = [];
    selectionComplete = false;

    // Get the number of draws and check for options
    let draws = parseInt(document.getElementById("draws").value);
    const hasAdvantage = document.getElementById("advantage").checked;
    const hasDisadvantage = document.getElementById("disadvantage").checked;
    const hasMagic = document.getElementById("magic").checked;

    // Draw cards based on conditions
    let drawnCards;
    if (hasAdvantage) {
        drawnCards = drawCards(draws + 2);
        cardsToSelect = 2;
    } else if (hasDisadvantage) {
        drawnCards = drawCards(draws);
        cardsToSelect = 2;
    } else {
        drawnCards = drawCards(draws);
    }

    // Clear the container
    document.getElementById("cardsContainer").innerHTML = "";
    document.getElementById("result").innerHTML = "Drawing cards...";
    document.getElementById("selectionPanel").classList.remove('active');

    // Display cards with animation
    drawnCards.forEach((card, index) => {
        let cardDiv = document.createElement("div");
        cardDiv.classList.add("card");
        cardDiv.setAttribute('data-index', index);

        if (hasAdvantage || hasDisadvantage) {
            cardDiv.classList.add("selectable");
        }

        let cardValueDiv = document.createElement("div");
        cardValueDiv.classList.add("card-value");

        let cardSuitDiv = document.createElement("div");
        cardSuitDiv.classList.add("card-suit");

        if (card.value === 'Joker') {
            // Enhanced Joker styling
            cardDiv.classList.add("joker");
            cardValueDiv.innerHTML = "JOKER";
            cardSuitDiv.innerHTML = "üÉè";

            // Set a specific data attribute for joker identification
            cardDiv.setAttribute('data-joker', 'true');

            // Add explicit click handling (making sure it overrides any other handlers)
            cardDiv.addEventListener('click', function(e) {
                e.stopPropagation(); // Stop event bubbling
                replaceJoker(cardDiv, index);
            });

        } else {
            // Set color for red suits
            if (card.suit === '‚ô¶Ô∏è' || card.suit === '‚ô•Ô∏è') {
                cardValueDiv.style.color = "#ff5722";
                cardSuitDiv.style.color = "#ff5722";
            }
            cardValueDiv.innerHTML = card.value;
            cardSuitDiv.innerHTML = card.suit;
        }

        cardDiv.appendChild(cardValueDiv);
        cardDiv.appendChild(cardSuitDiv);
        document.getElementById("cardsContainer").appendChild(cardDiv);

        // Store the card data and element
        originalCards.push({
            data: card,
            element: cardDiv
        });

        // Add animation delay
        cardDiv.style.animationDelay = `${index * 0.15}s`;
    });

    // Process after cards are displayed
    setTimeout(() => {
        const jokerElements = document.querySelectorAll('#cardsContainer .card[data-joker="true"]');
        const hasJokers = jokerElements.length > 0;

        if (hasJokers) {
            document.getElementById('result').innerHTML = "Click on the Joker card to replace it!";
        } else if (hasAdvantage || hasDisadvantage) {
            startCardSelection(hasAdvantage);
        } else {
            calculateSuccesses(originalCards.map(card => card.data));
        }
    }, Math.max(500, drawnCards.length * 200));
}


function replaceJoker(jokerCard, index) {
    Swal.fire({
        title: 'Replace Joker Card',
        html: `
            <div style="font-family: 'Comic Neue', cursive; font-size: 1.2em;">
                <p>Choose a card to replace the Joker:</p>
                <div style="margin-top: 20px;">
                    <label>Suit:</label>
                    <select id="suit" style="font-size: 0.9em; padding: 8px; margin: 10px; width: 150px;">
                        <option value="‚ô†Ô∏è">‚ô†Ô∏è Spades</option>
                        <option value="‚ô¶Ô∏è">‚ô¶Ô∏è Diamonds</option>
                        <option value="‚ô£Ô∏è">‚ô£Ô∏è Clubs</option>
                        <option value="‚ô•Ô∏è">‚ô•Ô∏è Hearts</option>
                    </select>
                    
                    <label>Value:</label>
                    <select id="value" style="font-size: 1.2em; padding: 8px; margin: 10px; width: 150px;">
                        <option value="A">Ace</option>
                        <option value="K">King</option>
                        <option value="Q">Queen</option>
                        <option value="J">Jack</option>
                        <option value="10">10</option>
                        <option value="9">9</option>
                        <option value="8">8</option>
                        <option value="7">7</option>
                        <option value="6">6</option>
                        <option value="5">5</option>
                        <option value="4">4</option>
                        <option value="3">3</option>
                        <option value="2">2</option>
                    </select>
                </div>
            </div>
        `,
        confirmButtonText: 'Replace Card',
        confirmButtonColor: '#4CAF50',
        background: '#2d2d2d',
        color: '#fff',
        showCancelButton: false
    }).then((result) => {
        if (result.isConfirmed) {
            // Get the selected value and suit
            const newValue = document.getElementById("value").value;
            const newSuit = document.getElementById("suit").value;
            
            // Convert to numeric value
            let numValue;
            if (newValue === 'J') numValue = 11;
            else if (newValue === 'Q') numValue = 12;
            else if (newValue === 'K') numValue = 13;
            else if (newValue === 'A') numValue = 14;
            else numValue = parseInt(newValue);
            
            // Create the new card data
            const newCard = { value: newValue, suit: newSuit, numValue: numValue };
            
            // Update the original cards array
            originalCards[index].data = newCard;
            
            // Update the card visually
            jokerCard.classList.remove("joker");
            jokerCard.removeAttribute("data-joker");
            jokerCard.innerHTML = "";
            
            // Create new card content
            const cardValueDiv = document.createElement("div");
            cardValueDiv.classList.add("card-value");
            cardValueDiv.innerText = newValue;
            
            const cardSuitDiv = document.createElement("div");
            cardSuitDiv.classList.add("card-suit");
            cardSuitDiv.innerText = newSuit;
            
            // Add color for red suits
            if (newSuit === '‚ô¶Ô∏è' || newSuit === '‚ô•Ô∏è') {
                cardValueDiv.style.color = "#ff5722";
                cardSuitDiv.style.color = "#ff5722";
            }
            
            // Reset card styling
            jokerCard.style.border = "";
            jokerCard.style.background = "white";
            jokerCard.style.boxShadow = "";
            
            // Add the new content
            jokerCard.appendChild(cardValueDiv);
            jokerCard.appendChild(cardSuitDiv);
            
            // Recalculate successes
            calculateSuccesses(originalCards.map(card => card.data));
        }
    });
}

function startCardSelection(isAdvantage) {
    // Start card selection mode
    isSelectingCards = true;
    document.getElementById('selectionCount').textContent = "0";
    document.getElementById('selectionPanel').classList.add('active');
    
    // Set message based on mode
    if (isAdvantage) {
        document.getElementById('result').innerHTML = "You have advantage! Select 2 cards to drop.";
    } else {
        document.getElementById('result').innerHTML = "You have disadvantage! Select 2 cards to drop.";
    }
}

function calculateSuccesses(cards) {
    // Create separate counters
    let valueCounts = {};
    let suitCounts = {};
    
    // Track individual matches
    let valueMatches = 0;
    let suitMatches = 0;
    
    // First just count occurrences
    cards.forEach(card => {
        if (card && card.value !== 'Joker') {
            // Use numeric value for calculation
            let calcValue = card.numValue || card.value;
            valueCounts[calcValue] = (valueCounts[calcValue] || 0) + 1;
            suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;
        }
    });
    
    // Calculate value matches
    Object.entries(valueCounts).forEach(([value, count]) => {
        if (count >= 2) {
            if (count === 2) valueMatches += 1;
            if (count === 3) valueMatches += 2;
            if (count === 4) valueMatches += 3;
            if (count === 5) valueMatches += 4;
        }
    });
    
    // Calculate suit matches
    Object.entries(suitCounts).forEach(([suit, count]) => {
        if (count >= 2) {
            if (count === 2) suitMatches += 1;
            if (count === 3) suitMatches += 2;
            if (count === 4) suitMatches += 3;
            if (count === 5) suitMatches += 4;
        }
    });
    
    // Total successes
    let successes = valueMatches + suitMatches;
    
    // Create result message
    let message = "";
    if (successes === 0) {
        message = "No successes. Try again!";
    } else if (successes === 1) {
        message = "1 success! Not bad!";
    } else if (successes === 2) {
        message = "2 successes! Good job!";
    } else if (successes === 3) {
        message = "3 successes! Excellent!";
    } else {
        message = `${successes} successes! Amazing luck!`;
    }
    
    // Display detailed breakdown
    document.getElementById("result").innerHTML = `
        <div>${message}</div>
        <div class="successes-breakdown">
            <div class="breakdown-item values">
                <span>${valueMatches} from values</span>
            </div>
            <div class="breakdown-item suits">
                <span>${suitMatches} from suits</span>
            </div>
        </div>
    `;

    // Handle magic effects if needed
    const hasMagic = document.getElementById("magic").checked;
    if (hasMagic) {
        if (checkForHighCardTie(cards)) {
            handleHighCardTie(cards);
        } else {
            const highestCard = getHighestCard(cards);
            displayMagicEffect(highestCard);
        }
    }
}

// Functions for magic effects
function getHighestCard(cards) {
    const nonJokerCards = cards.filter(card => card.value !== 'Joker');
    if (nonJokerCards.length === 0) return null;
    
    const suitRank = {
        '‚ô•Ô∏è': 4,
        '‚ô¶Ô∏è': 3,
        '‚ô£Ô∏è': 2,
        '‚ô†Ô∏è': 1
    };
    
    const sortedCards = nonJokerCards.sort((a, b) => {
        if (b.numValue !== a.numValue) {
            return b.numValue - a.numValue;
        }
        return suitRank[b.suit] - suitRank[a.suit];
    });
    
    return sortedCards[0];
}

function checkForHighCardTie(cards) {
    const nonJokerCards = cards.filter(card => card.value !== 'Joker');
    if (nonJokerCards.length === 0) return false;
    
    const highestValue = Math.max(...nonJokerCards.map(card => card.numValue));
    const highestCards = nonJokerCards.filter(card => card.numValue === highestValue);
    
    return highestCards.length > 1;
}

function handleHighCardTie(cards) {
    const nonJokerCards = cards.filter(card => card.value !== 'Joker');
    const highestValue = Math.max(...nonJokerCards.map(card => card.numValue));
    const highestCards = nonJokerCards.filter(card => card.numValue === highestValue);

    window.tieHighCards = highestCards;

    let buttonsHTML = highestCards.map((card, index) => {
        return `
            <button 
                type="button" 
                class="swal2-confirm swal2-styled" 
                style="display: inline-block; margin: 5px; min-width: 150px; background-color: #4CAF50;"
                onclick="selectHighCard(${index})"
            >
                ${card.value} ${card.suit}<br>
                <small>${getMagicEffectDescription(card)}</small>
            </button>
        `;
    }).join("");

    Swal.fire({
        title: 'Tie for Highest Card!',
        html: `
            <div style="font-family: 'Comic Neue', cursive; font-size: 1.2em;">
                <p>Select which card to use for the magic effect:</p>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                    ${buttonsHTML}
                </div>
            </div>
        `,
        showConfirmButton: false,
        showCancelButton: false,
        background: '#2d2d2d',
        color: '#fff'
    });
}

function getMagicEffectDescription(card) {
    let effect = "";

    if (card.suit === '‚ô•Ô∏è') {
        effect = "Emotions, Charm, Healing";
    } else if (card.suit === '‚ô†Ô∏è') {
        effect = "Destruction, Bad Luck, Debuffs";
    } else if (card.suit === '‚ô¶Ô∏è') {
        effect = "Reality Manipulation, Creation";
    } else if (card.suit === '‚ô£Ô∏è') {
        effect = "Movement, Speed, Physicality";
    }

    let additionalEffect = "";
    if (card.value === 'J') {
        additionalEffect = "+ Swaps Targets";
    } else if (card.value === 'Q') {
        additionalEffect = "+ Affects Wider Area";
    } else if (card.value === 'K') {
        additionalEffect = "+ Ignores Reality";
    } else if (card.value === 'A') {
        additionalEffect = "+ Wild Card (GM Twist)!";
    }

    return `${effect} ${additionalEffect}`;
}

function selectHighCard(index) {
    Swal.close();
    const selectedCard = window.tieHighCards[index];
    displayMagicEffect(selectedCard);
}

function getFullSuitName(suitSymbol) {
    switch(suitSymbol) {
        case '‚ô†Ô∏è': return 'Spades';
        case '‚ô¶Ô∏è': return 'Diamonds';
        case '‚ô£Ô∏è': return 'Clubs';
        case '‚ô•Ô∏è': return 'Hearts';
        default: return suitSymbol;
    }
}

function displayMagicEffect(highestCard) {
    if (!highestCard) {
        document.getElementById("result").innerHTML += `<div id="magicEffect">No magical effect determined.</div>`;
        return;
    }

    const effectDescription = getMagicEffectDescription(highestCard);

    let magicHTML = `
        <div class="magic-results">
            <h3>Magic Effect (Highest Card: ${highestCard.value} ${highestCard.suit})</h3>
            <div class="magic-effect-box">
                ${effectDescription}
            </div>
        </div>
    `;

    const magicEffectDiv = document.getElementById("magicEffect");
    if (magicEffectDiv) {
        magicEffectDiv.innerHTML = magicHTML;
    } else {
        document.getElementById("result").innerHTML += `<div id="magicEffect">${magicHTML}</div>`;
    }
}
</script>
 
</body>
</html>
